## 第2章 、Scope & Closures（作用域和闭包）

### 2.1 什么是作用域

几乎所有的编程语言都将值存储于变量中，然后通过变量检索或修改这些值。通过一套定义明确的规则，将变量存储在某个位置，并在以后找到这些变量。这套规则称为：作用域。

#### 2.1.1 编译理论

尽管 JavaScript 是动态类型语言（或解释类型语言），JavaScript 引擎还是会对它进行一系列的编译，就像其它语言那样。编译语言的程序源代码块通常在执行前经历三个步骤，即“编译”：

1. **分词/词法分析：** 将一连串字符打断成（对于语言来说）有意义的片段，称为 token（记号）。举例来说，考虑这段程序：`var a = 2;`。这段程序很可能会被打断成如下 token：`var`，`a`，`=`，`2`，和 `;`。空格也许会被保留为一个 token，这要看它是否是有意义的。

   **注意：** 分词和词法分析之间的区别是微妙和学术上的，其中心在于这些 token 是否以 *无状态* 或 *有状态* 的方式被识别。简而言之，如果分词器去调用有状态的解析规则来弄清`a`是否应当被考虑为一个不同的 token，还是只是其他 token 的一部分，那么这就是 **词法分析**。

2. **解析：** 将一个 token 的流（数组）转换为一个嵌套元素的树，它综合地表示了程序的语法结构。这棵树称为“抽象语法树”（AST —— **A**bstract **S**yntax **T**ree）。

   `var a = 2;` 的树也许开始于称为 `VariableDeclaration`（变量声明）顶层节点，带有一个称为 `Identifier`（标识符）的子节点（它的值为 `a`），和另一个称为 `AssignmentExpression`（赋值表达式）的子节点，而这个子节点本身带有一个称为 `NumericLiteral`（数字字面量）的子节点（它的值为`2`）。

3. **代码生成：** 这个处理将抽象语法树转换为可执行的代码。这一部分将根据语言，它的目标平台等因素有很大的不同。

   所以，与其深陷细节，我们不如笼统地说，有一种方法将我们上面描述的 `var a = 2;` 的抽象语法树转换为机器指令，来实际上 *创建* 一个称为 `a` 的变量（包括分配内存等等），然后在 `a` 中存入一个值。

   **注意：** 引擎如何管理系统资源的细节远比我们要挖掘的东西深刻，所以我们将理所当然地认为引擎有能力按其需要创建和存储变量。

上面这三个步骤还只是完整编译过程的大概，实际的编译要比这复杂的多。JavaScript 引起为了保证性能，做了各种优化，其编译速度是非常快的，快到我们开发人员根本无需关心这个编译细节。

> 对于开发人员而言，JS 编译器拿到代码块`var a = 2;`，首先编译它，然后运行它，就是这样。

#### 2.1.2 理解作用域

处理代码块`var a = 2;`涉及下面三个概念：

- **引擎**，负责从始至终的编译和执行我们的 JavaScript 程序。
- **编译器**，引擎的的朋友之一； 处理所有繁琐的解析和代码生成工作。
- **作用域**，*引擎* 的另一个朋友；收集并维护一张所有被声明的标识符（变量）的列表，并对当前执行中的代码如何访问这些变量强制实施一组严格的规则。

对于代码块`var a = 2;`，根据上面的概念，实际执行时有如下两个步骤：

- 编译器首先会在作用域内查找变量`a`，如果存在则继续，不存在则声明一个变量`a`，然后继续下一步——编译器为引擎生成稍后要执行的代码。
- 引擎执行代码，先在作用域内查找变量`a`，当前作用域找不到就到*可访问的上层作用域（作用域链）*查找，找到了就执行赋值语句`a=2`，找不到变量`a`就报错。

**注意：** 在 JS 中，如果未声明的变量前面没有`var`这种声明性的关键字，编译器会把变量声明挂载到全局对象`window`上。引擎找不到变量报错的情况，目前能想到的是引用类型的变量上找不到对应的属性，给该属性赋值会报错。基本类型的变量应该都会挂到`window`上。

#### 2.1.3 编译器术语

这里讲到了什么是“左值”和“右值”，也就是左查询（Left-hand Side，LHS）和右查询（Right-hand Side，RHS）。

简单来说，当一个变量出现在赋值操作的左手边时，会进行 LHS 查询，当一个变量出现在赋值操作的右手边时，会进行 RHS 查询。

> RHS 的意思是“去取……的值”。

从概念上可以理解为：“赋值的目标（LHS）”和“赋值的源（RHS）”。



### 总结

- 作用域是一组规则，它决定了一个变量（标识符）在哪里和如何被查找（可以使用的范围）。
- 左值 - 赋值的目标（LHS）
- 右值 - 赋值的源（RHS）